/*!
	photobox v1.6.1
	(c) 2012 Yair Even Or <http://dropthebit.com>

	Uses jQuery-mousewheel Version: 3.0.6
	(c) 2009 Brandon Aaron <http://brandonaaron.net>

	MIT-style license.
*/
(function(a){function N(a){var c,d=b.createElement("p").style,e=["ms","O","Moz","Webkit"];if(""==d[a])return a;for(a=a[0].toUpperCase()+a.slice(1),c=e.length;c--;)if(""==d[e[c]+a])return e[c]+a}function O(a){var b=a.keyCode,c=g.keys;return c.close.indexOf(b)>=0&&Y()||c.next.indexOf(b)>=0&&P("next")||c.prev.indexOf(b)>=0&&P("prev")||!0}function P(a){if(M.hasClass("hide"))return!1;var b="pbPrevBtn"==this.id||"prev"==a?l:m,c="both"==K.css("clear");return Q(b,0,c),!1}function Q(a,b,c){(!a||0>a)&&(a=0),j=a,k=h[a][0],l=(j||(g.loop?h.length:0))-1,m=(j+1)%h.length||(g.loop?0:-1),X(),M.addClass("pbLoading").removeClass("error"),g.loop||a!=h.length-1?G.removeClass("hide"):G.addClass("hide"),g.loop||0!=a?F.removeClass("hide"):F.addClass("hide"),g.thumbs&&n.changeActive(a,b,c),l>=0&&(B.src=h[l][0]),m>=0&&(C.src=h[m][0]),g.counter&&H.find(".counter").text("( "+(j+1)+" / "+h.length+" )"),g.title&&H.find(".title").text(h[a][1]),r&&M.addClass("hide"),g.autoplay&&p.progress.reset(),A=new Image,A.onload=function(){T(b)},A.onerror=function(){S()},A.src=k,R.save()}function S(){M.removeClass("pbLoading").addClass("error"),E[0].src=x,A.onerror=null}function T(a){function b(){E.off(q).css({transition:"0s"}),E[0].src=k,E[0].className="prepare",setTimeout(function(){M.removeClass("hide"),E.removeAttr("style").prop("class",""),setTimeout(function(){E[0].className="",E.on(q,U),r&&U()},0)},50)}M.removeClass("pbLoading").addClass("hide"),E.removeClass("zoomable"),a?b():(E.on(q,b),r&&b())}function U(){E.off(q),E.addClass("zoomable"),J&&g.autoplay&&p.play(),"function"==typeof f.callback&&f.callback()}function V(c,d){var e=E.data("zoom")||1,f=E[0].getBoundingClientRect();return e+=d/10,.1>e&&(e=.1),E.data("zoom",e).css({transform:"scale("+e+")"}),f.height>o.clientHeight||f.width>o.clientWidth?a(b).on("mousemove.photobox",W):(a(b).off("mousemove.photobox"),E[0].style[y]="50% 50%"),!1}function W(a){var b=a.clientY/o.clientHeight*(o.clientHeight+200)-100,c=100*(b/o.clientHeight),d=100*(a.clientX/o.clientWidth),e=d.toFixed(2)+"% "+c.toFixed(2)+"%";E[0].style[y]=e}function X(){clearTimeout(p.autoPlayTimer),a(b).off("mousemove.photobox"),A.onload=function(){},A.src=B.src=C.src=k}function Y(){function a(){""!=M[0].className&&(M.removeClass("show hide"),E.removeAttr("class").removeAttr("style").off().data("zoom",1),s&&setTimeout(function(){M.hide()},200))}X(),d.prototype.setup(),R.clear(),M.removeClass("on").addClass("hide"),E.on(q,a),r&&a(),setTimeout(a,500)}function _(b){var d=b||c.event,e=[].slice.call(arguments,1),f=0,h=0,i=0;return b=a.event.fix(d),b.type="mousewheel",d.wheelDelta&&(f=d.wheelDelta/120),d.detail&&(f=-d.detail/3),i=f,void 0!==d.axis&&d.axis===d.HORIZONTAL_AXIS&&(i=0,h=-1*f),void 0!==d.wheelDeltaY&&(i=d.wheelDeltaY/120),void 0!==d.wheelDeltaX&&(h=-1*d.wheelDeltaX/120),e.unshift(b,f,h,i),(a.event.dispatch||a.event.handle).apply(this,e)}var d,f,g,k,l,m,n,o,p,u,v,D,E,F,G,H,I,J,K,b=document,c=window,e=[],h=[],j=-1,q="transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd",r=!("placeholder"in b.createElement("input")),s=!!c.ActiveXObject,t="ontouchend"in b,w=a(),x="data:image/gif;base64,R0lGODlhAQABAIAAAP///////yH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",y=N("transformOrigin"),z=N("transition"),A={},B=new Image,C=new Image,L={loop:!0,thumbs:!0,counter:!0,title:!0,autoplay:!1,time:3e3,history:!0,hideFlash:!0,keys:{close:"27, 88, 67",prev:"37, 80",next:"39, 78"}},M=a('<div id="pbOverlay">').hide().append(I=a('<div class="pbLoader"><b></b><b></b><b></b></div>'),F=a('<div id="pbPrevBtn" class="prevNext"><b class="icon-chevron-left icon-large"></b></div>').on("click",P),G=a('<div id="pbNextBtn" class="prevNext"><b class="icon-chevron-right icon-large"></b></div>').on("click",P),imageWrap=a('<div class="imageWrap">').append(E=a("<img>"))[0],D=a('<div id="pbCloseBtn">').append('<b class="icon-remove-sign icon-large"></b>').on("click",Y)[0],J=a('<div id="pbAutoplayBtn">').append(a('<div class="pbProgress">')),H=a('<div id="pbCaption">').append('<div class="title"></div><div class="counter">',K=a("<div>").addClass("pbThumbs")));a(b).ready(function(){r&&M.addClass("msie"),J.on("click",p.toggle),K.on("click","a",n.click),t&&K.css("overflow","auto"),M.on("click","img",function(a){a.stopPropagation()}),a(b.body).prepend(a(M)),o=b.documentElement}),a.fn.photobox=function(b,c,f){"string"!=typeof b&&(b="a");var g=a.extend({},L,c||{}),h=new d(g,this,b);return h.callback=f,e.push(h),R.load(),this},d=function(c,d,e){this.options=a.extend({},c),this.target=e,this.selector=a(d||b),this.thumbsList=null;var f=this.imageLinksFilter(d.find(e));this.imageLinks=f[0],this.images=f[1],this.init()},d.prototype={init:function(){var a=this;this.selector.data("_photobox",this),this.options.thumbs&&(this.thumbsList=n.generate(this.imageLinks)),this.selector.on("click.photobox",this.target,function(b){b.preventDefault(),a.open(this)}),this.observerTimeout=null,1==this.selector[0].nodeType&&this.observeDOM(this.selector[0],function(){clearTimeout(this.observerTimeout),this.observerTimeout=setTimeout(function(){var b=a.imageLinksFilter(a.selector.find(a.target));a.imageLinks=b[0],a.images=b[1],a.thumbsList=n.generate(a.imageLinks)},50)})},open:function(b){var c=a.inArray(b,this.imageLinks);return-1==c?!1:(g=this.options,h=this.images,f=this,this.setup(1),Q(c,!0))},imageLinksFilter:function(a){var b=[];return[a.filter(function(){var c=this,d=c.firstElementChild||this.children[0];return d&&d.tagName&&"img"==d.tagName.toLowerCase()?(b.push([c.href,d.getAttribute("alt")||d.getAttribute("title")]),!0):!1}),b]},observeDOM:function(){var a=c.MutationObserver||c.WebKitMutationObserver,b=c.addEventListener;return function(c,d){if(a){var e=new a(function(a){(a[0].addedNodes.length||a[0].removedNodes.length)&&d()});e.observe(c,{childList:!0,subtree:!0})}else b&&(c.addEventListener("DOMNodeInserted",d,!1),c.addEventListener("DOMNodeRemoved",d,!1))}}(),setup:function(d){var e=d?"on":"off";d?(E[0].src=x,E.css({transition:"0s"}).removeAttr("style"),M.show(),K.html(this.thumbsList),M[g.thumbs?"addClass":"removeClass"]("thumbs"),g.thumbs&&(w.removeAttr("class"),a(c).on("resize.photobox",n.calc),n.calc()),2>this.images.length?M.removeClass("thumbs hasArrows hasCounter hasAutoplay"):(M.addClass("hasArrows hasCounter"),g.time>1e3?(M.addClass("hasAutoplay"),g.autoplay?p.progress.start():p.pause()):M.removeClass("hasAutoplay")),M.on(q,function(){M.off(q).addClass("on")}).addClass("show"),r&&M.trigger("MSTransitionEnd")):a(c).off("resize.photobox"),g.hideFlash&&a.each(["object","embed"],function(b,c){a(c).each(function(){d&&(this._photobox=this.style.visibility),this.style.visibility=d?"hidden":this._photobox})}),a(b)[e]({"keydown.photobox":O,"mousewheel.photobox":V})}},n={generate:function(b){var d,f,g,c=a("<ul>"),e=[];for(f=b.toArray().length;f--;)d=b[f],g=d.children[0].title||d.children[0].alt||"",e.push('<li><a href="'+d.href+'"><img src="'+d.children[0].src+'" alt="" title="'+g+'" /></a></li>');return c.html(e.reverse().join("")),c},click:function(b){b.preventDefault(),w.removeClass("active"),w=a(this).parent().addClass("active");var c=a(this.parentNode).index();return Q(c,0,1)},changeActiveTimeout:null,changeActive:function(a,b,c){w.index(),w.removeClass("active"),w=K.find("li").eq(a).addClass("active"),c||(clearTimeout(this.changeActiveTimeout),this.changeActiveTimeout=setTimeout(function(){var a=w[0].offsetLeft+w[0].clientWidth/2-o.clientWidth/2;b&&K.delay(800),!b&&K.stop(),K.animate({scrollLeft:a},500,"swing")},200))},calc:function(){u=K[0].clientWidth,v=K[0].firstChild.clientWidth;var a=v>u?"on":"off";!t&&K[a]("mousemove",n.move)},move:function(a){var b=v/u;K[0].scrollLeft=a.pageX*b-500}},p={autoPlayTimer:!1,play:function(){p.autoPlayTimer=setTimeout(function(){Q(m)},g.time),p.progress.start(),J.removeClass("icon-play icon-large").addClass("icon-pause icon-large"),p.setTitle("Click to stop autoplay"),g.autoplay=!0},pause:function(){clearTimeout(p.autoPlayTimer),p.progress.reset(),J.addClass("icon-play icon-large").removeClass("icon-pause icon-large"),p.setTitle("Click to resume autoplay"),g.autoplay=!1},progress:{reset:function(){J.find("div").removeAttr("style"),setTimeout(function(){J.removeClass("playing")},200)},start:function(){r||J.find("div").css(z,g.time+"ms"),J.addClass("playing")}},setTitle:function(a){a&&J.prop("title",a+" (every "+g.time/1e3+" seconds)")},toggle:function(a){a.stopPropagation(),p[g.autoplay?"pause":"play"]()}};var R={save:function(){"pushState"in window.history&&decodeURIComponent(window.location.hash.slice(1))!=k&&g.history&&window.history.pushState("photobox",b.title+"-"+h[j][1],window.location.pathname+window.location.search+"#"+encodeURIComponent(k))},load:function(){if(g&&!g.history)return!1;var b,c,a=decodeURIComponent(window.location.hash.slice(1));if(!a&&M.hasClass("show"))Y();else for(b=0;e.length>b;b++)for(c in e[b].images)if(e[b].images[c][0]==a)return e[b].open(e[b].imageLinks[c]),!0},clear:function(){g.history&&"pushState"in window.history&&window.history.pushState("photobox",b.title,window.location.pathname+window.location.search)}};window.onpopstate=function(){var a=window.onpopstate;return function(b){a&&a.apply(this,arguments),"photobox"==b.state&&R.load()}}();var Z=["DOMMouseScroll","mousewheel"];if(a.event.fixHooks)for(var $=Z.length;$;)a.event.fixHooks[Z[--$]]=a.event.mouseHooks;a.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var a=Z.length;a;)this.addEventListener(Z[--a],_,!1);else this.onmousewheel=_},teardown:function(){if(this.removeEventListener)for(var a=Z.length;a;)this.removeEventListener(Z[--a],_,!1);else this.onmousewheel=null}},a.fn.extend({mousewheel:function(a){return a?this.bind("mousewheel",a):this.trigger("mousewheel")},unmousewheel:function(a){return this.unbind("mousewheel",a)}})})(jQuery);